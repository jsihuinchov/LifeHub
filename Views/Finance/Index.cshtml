@using LifeHub.Models.Entities
@using LifeHub.Models.IA.Results
@using LifeHub.Models.ViewModels
@using LifeHub.Services
@inject IHabitService HabitService
@inject ISubscriptionService SubscriptionService
@model List<Habit>

@{
    ViewData["Title"] = "Mis Hábitos";
    
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var stats = ViewBag.Stats as HabitStatsViewModel;
    var userSubscription = ViewBag.UserSubscription as UserSubscription;
    var userPlan = userSubscription?.Plan;
    var hasAIFeatures = ViewBag.HasAIFeatures as bool? ?? false;
    
    // ✅ NUEVO: Datos de IA
    var aiRecommendations = ViewBag.AIRecommendations as List<HabitRecommendation> ?? new List<HabitRecommendation>();
    var consistencyAlerts = ViewBag.ConsistencyAlerts as List<ConsistencyAlert> ?? new List<ConsistencyAlert>();
    var habitPatterns = ViewBag.HabitPatterns as List<HabitPattern> ?? new List<HabitPattern>();
    
    var canCreateHabit = await SubscriptionService.CanUserCreateHabitAsync(userId ?? "");
    var habitUsage = await HabitService.GetHabitUsageAsync(userId ?? "");
}

<div class="habits-container">
    <!-- Header Principal -->
    <div class="habits-header">
        <div class="header-content">
            <h1 class="habits-title">
                <i class="fas fa-seedling me-3"></i>Mis Hábitos
            </h1>
            <p class="habits-subtitle">Construye una mejor versión de ti mismo, un hábito a la vez</p>
            
            @if (userPlan != null)
            {
                <div class="current-plan-badge">
                    <span class="badge" style="background: @userPlan.ColorCode; color: white;">
                        <i class="fas fa-crown me-1"></i>Plan @userPlan.Name
                        @if (userSubscription?.DaysRemaining <= 7)
                        {
                            <span class="ms-1">• Renueva en @userSubscription.DaysRemaining días</span>
                        }
                    </span>
                </div>
            }
        </div>
        <div class="header-actions">
            @if (canCreateHabit)
            {
                <a href="@Url.Action("Create", "Habits")" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Nuevo Hábito
                </a>
            }
            else
            {
                <button class="btn btn-primary" disabled title="Límite de hábitos alcanzado en tu plan actual">
                    <i class="fas fa-plus me-2"></i>Nuevo Hábito
                </button>
            }
            <a href="@Url.Action("Stats", "Habits")" class="btn btn-outline-primary">
                <i class="fas fa-chart-line me-2"></i>Estadísticas
            </a>
        </div>
    </div>

    <!-- Alerta de límite de hábitos -->
    @if (!canCreateHabit && userPlan != null)
    {
        <div class="alert alert-warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Límite de hábitos alcanzado</strong> - Has usado los @userPlan.MaxHabits hábitos de tu plan @userPlan.Name
                </div>
                <a href="@Url.Action("Index", "Plans")" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-rocket me-1"></i>Mejorar Plan
                </a>
            </div>
        </div>
    }

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>@TempData["ErrorMessage"]
        </div>
    }

    <!-- === SECCIÓN DE IA - SOLO PARA USUARIOS CON ACCESO === -->
    @if (hasAIFeatures)
    {
        <div class="ai-habits-section">
            <!-- Alertas de Consistencia -->
            @if (consistencyAlerts.Any())
            {
                <div class="habits-card alerts-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-robot me-2"></i>
                            Alertas de Consistencia
                            <span class="badge bg-purple ms-1">AI</span>
                        </h3>
                        <span class="alert-count">@consistencyAlerts.Count alerta(s)</span>
                    </div>
                    <div class="card-body">
                        <div class="alerts-list">
                            @foreach (var alert in consistencyAlerts.Take(3))
                            {
                                <div class="alert-item @alert.AlertType.ToLower()">
                                    <div class="alert-icon">
                                        @switch (alert.AlertType)
                                        {
                                            case "AtRisk":
                                                <i class="fas fa-exclamation-triangle"></i>
                                                break;
                                            case "Inconsistent":
                                                <i class="fas fa-chart-line"></i>
                                                break;
                                            case "Declining":
                                                <i class="fas fa-arrow-down"></i>
                                                break;
                                            default:
                                                <i class="fas fa-bell"></i>
                                                break;
                                        }
                                    </div>
                                    <div class="alert-content">
                                        <div class="alert-title">@alert.HabitName</div>
                                        <div class="alert-message">@alert.Message</div>
                                        <div class="alert-progress">
                                            <div class="progress-bar">
                                                <div class="progress-fill" style="width: @alert.CurrentConsistency%;"></div>
                                            </div>
                                            <div class="progress-stats">
                                                <span>Consistencia: @alert.CurrentConsistency.ToString("N1")%</span>
                                                <span>Objetivo: @alert.TargetConsistency.ToString("N1")%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="alert-severity @alert.AlertType.ToLower()">
                                        @alert.AlertType
                                    </div>
                                </div>
                            }
                        </div>
                        @if (consistencyAlerts.Count > 3)
                        {
                            <div class="text-center mt-3">
                                <small class="text-muted">Y @(consistencyAlerts.Count - 3) alertas más...</small>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Recomendaciones Inteligentes -->
            @if (aiRecommendations.Any())
            {
                <div class="habits-card recommendations-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-magic me-2"></i>
                            Recomendaciones Inteligentes
                            <span class="badge bg-purple ms-1">AI</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="recommendations-list">
                            @foreach (var recommendation in aiRecommendations.Take(3))
                            {
                                <div class="recommendation-item">
                                    <div class="recommendation-header">
                                        <div class="recommendation-habit">
                                            <i class="fas fa-bullseye me-2"></i>
                                            @recommendation.HabitName
                                        </div>
                                        <div class="recommendation-confidence">
                                            <span class="confidence-badge" style="background: @GetConfidenceColor(recommendation.Confidence)">
                                                @(recommendation.Confidence * 100)%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="recommendation-content">
                                        <p class="recommendation-text">@recommendation.Recommendation</p>
                                        <div class="recommendation-type">
                                            <span class="type-badge @recommendation.Type.ToLower()">@GetRecommendationTypeDisplay(recommendation.Type)</span>
                                        </div>
                                    </div>
                                    <div class="recommendation-reasoning">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle me-1"></i>
                                            @recommendation.Reason
                                        </small>
                                    </div>
                                </div>
                            }
                        </div>
                        @if (aiRecommendations.Count > 3)
                        {
                            <div class="text-center mt-3">
                                <small class="text-muted">Y @(aiRecommendations.Count - 3) recomendaciones más...</small>
                            </div>
                        }
                    </div>
                </div>
            }

            <!-- Patrones Detectados -->
            @if (habitPatterns.Any())
            {
                <div class="habits-card patterns-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-project-diagram me-2"></i>
                            Patrones Detectados
                            <span class="badge bg-purple ms-1">AI</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="patterns-list">
                            @foreach (var pattern in habitPatterns.Take(2))
                            {
                                <div class="pattern-item">
                                    <div class="pattern-icon">
                                        @switch (pattern.PatternType)
                                        {
                                            case "Weekly":
                                                <i class="fas fa-calendar-week"></i>
                                                break;
                                            case "CategoryBased":
                                                <i class="fas fa-tags"></i>
                                                break;
                                            case "Progression":
                                                <i class="fas fa-chart-line"></i>
                                                break;
                                            default:
                                                <i class="fas fa-chart-bar"></i>
                                                break;
                                        }
                                    </div>
                                    <div class="pattern-content">
                                        <div class="pattern-title">@pattern.Description</div>
                                        <div class="pattern-strength">
                                            <div class="strength-bar">
                                                <div class="strength-fill" style="width: @(pattern.Strength * 100)%;"></div>
                                            </div>
                                            <span class="strength-value">@(pattern.Strength.ToString("P0"))</span>
                                        </div>
                                        <div class="pattern-suggestion">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                @pattern.SuggestedAction
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Métricas Principales -->
    <div class="metrics-grid">
        <div class="metric-card total-habits">
            <div class="metric-icon">
                <i class="fas fa-seedling"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">@Model.Count</h3>
                <p class="metric-label">Total Hábitos</p>
                <div class="metric-trend info">
                    <i class="fas fa-chart-bar"></i>
                    <span>@habitUsage.current/@habitUsage.max en tu plan</span>
                </div>
            </div>
        </div>

        <div class="metric-card completion-rate">
            <div class="metric-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">@(stats?.CompletionRate.ToString("N1") ?? "0")%</h3>
                <p class="metric-label">Tasa de Completitud</p>
                <div class="metric-trend @(stats?.CompletionRate >= 70 ? "positive" : stats?.CompletionRate >= 50 ? "warning" : "negative")">
                    <i class="fas fa-@(stats?.CompletionRate >= 70 ? "trophy" : stats?.CompletionRate >= 50 ? "check" : "exclamation")"></i>
                    <span>@(stats?.CompletionRate >= 70 ? "Excelente" : stats?.CompletionRate >= 50 ? "Bueno" : "A mejorar")</span>
                </div>
            </div>
        </div>

        <div class="metric-card current-streak">
            <div class="metric-icon">
                <i class="fas fa-fire"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">@(stats?.CurrentStreak ?? 0)</h3>
                <p class="metric-label">Racha Actual</p>
                <div class="metric-trend @(stats?.CurrentStreak >= 7 ? "positive" : "info")">
                    <i class="fas fa-@(stats?.CurrentStreak >= 7 ? "fire" : "clock")"></i>
                    <span>@(stats?.CurrentStreak >= 7 ? "¡En llamas!" : "Sigue así")</span>
                </div>
            </div>
        </div>

        <div class="metric-card perfect-weeks">
            <div class="metric-icon">
                <i class="fas fa-star"></i>
            </div>
            <div class="metric-content">
                <h3 class="metric-value">@(stats?.PerfectWeeks ?? 0)</h3>
                <p class="metric-label">Semanas Perfectas</p>
                <div class="metric-trend @(stats?.PerfectWeeks >= 2 ? "positive" : "info")">
                    <i class="fas fa-@(stats?.PerfectWeeks >= 2 ? "crown" : "star")"></i>
                    <span>@(stats?.PerfectWeeks >= 2 ? "¡Impresionante!" : "Buen comienzo")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="habits-content">
        <!-- Columna Principal -->
        <div class="habits-main">
            <!-- Lista de Hábitos -->
            <div class="habits-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-list me-2"></i>
                        Mis Hábitos Activos
                    </h3>
                    <div class="card-actions">
                        <span class="habits-count">@Model.Count hábitos</span>
                        <div class="view-options">
                            <button class="btn-view active" data-view="grid">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="btn-view" data-view="list">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.Any())
                    {
                        <div class="habits-grid" id="habits-view">
                            @foreach (var habit in Model)
                            {
                                var completions = habit.HabitCompletions?.Where(hc => hc.Completed).ToList();
                                var todayCompleted = completions?.Any(hc => hc.CompletionDate.Date == DateTime.UtcNow.Date) == true;
                                var currentStreak = completions?.OrderByDescending(hc => hc.CompletionDate)
                                                              .TakeWhile((hc, i) => hc.Completed && hc.CompletionDate.Date == DateTime.UtcNow.Date.AddDays(-i))
                                                              .Count() ?? 0;

                                <div class="habit-card" data-habit-id="@habit.Id">
                                    <div class="habit-header">
                                        <div class="habit-icon" style="background: @habit.ColorCode;">
                                            <i class="@habit.Icon"></i>
                                        </div>
                                        <div class="habit-info">
                                            <h4 class="habit-name">@habit.Name</h4>
                                            <p class="habit-category">@habit.Category</p>
                                        </div>
                                        <div class="habit-actions">
                                            <button class="btn-favorite @(habit.IsFavorite ? "active" : "")" 
                                                    data-habit-id="@habit.Id"
                                                    title="@(habit.IsFavorite ? "Quitar de favoritos" : "Agregar a favoritos")">
                                                <i class="fas fa-star"></i>
                                            </button>
                                            <div class="dropdown">
                                                <button class="btn-more" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="@Url.Action("Edit", new { id = habit.Id })">
                                                            <i class="fas fa-edit me-2"></i>Editar
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="@Url.Action("HabitStats", new { id = habit.Id })">
                                                            <i class="fas fa-chart-line me-2"></i>Estadísticas
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <form asp-action="Delete" method="post" class="d-inline">
                                                            <input type="hidden" name="id" value="@habit.Id" />
                                                            <button type="submit" class="dropdown-item text-danger" 
                                                                    onclick="return confirm('¿Estás seguro de que quieres eliminar este hábito?')">
                                                                <i class="fas fa-trash me-2"></i>Eliminar
                                                            </button>
                                                        </form>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="habit-progress">
                                        <div class="progress-info">
                                            <span class="progress-label">Progreso semanal</span>
                                            <span class="progress-stats">
                                                @(completions?.Count(hc => hc.CompletionDate >= DateTime.UtcNow.AddDays(-7)) ?? 0)/@habit.Frequency
                                            </span>
                                        </div>
                                        <div class="progress-bar">
                                            @{
                                                var weeklyCompletions = completions?.Count(hc => hc.CompletionDate >= DateTime.UtcNow.AddDays(-7)) ?? 0;
                                                var progressPercentage = habit.Frequency > 0 ? (weeklyCompletions * 100) / habit.Frequency : 0;
                                            }
                                            <div class="progress-fill" style="width: @progressPercentage%;"></div>
                                        </div>
                                    </div>

                                    <div class="habit-stats">
                                        <div class="stat-item">
                                            <i class="fas fa-fire"></i>
                                            <span class="stat-value">@currentStreak</span>
                                            <span class="stat-label">días</span>
                                        </div>
                                        <div class="stat-item">
                                            <i class="fas fa-check-circle"></i>
                                            <span class="stat-value">@(completions?.Count ?? 0)</span>
                                            <span class="stat-label">total</span>
                                        </div>
                                        <div class="stat-item">
                                            <i class="fas fa-bullseye"></i>
                                            <span class="stat-value">@habit.Frequency</span>
                                            <span class="stat-label">/semana</span>
                                        </div>
                                    </div>

                                    <div class="habit-actions-main">
                                        <button class="btn-complete @(todayCompleted ? "completed" : "")" 
                                                data-habit-id="@habit.Id"
                                                data-date="@DateTime.UtcNow.ToString("yyyy-MM-dd")">
                                            <i class="fas fa-@(todayCompleted ? "check" : "plus")"></i>
                                            @(todayCompleted ? "Completado" : "Marcar hoy")
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <i class="fas fa-seedling fa-3x mb-3"></i>
                            <h4>No hay hábitos creados</h4>
                            <p>Comienza creando tu primer hábito para construir mejores rutinas</p>
                            @if (canCreateHabit)
                            {
                                <a href="@Url.Action("Create", "Habits")" class="btn btn-primary mt-2">
                                    <i class="fas fa-plus me-2"></i>Crear primer hábito
                                </a>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="habits-sidebar">
            <!-- Predicción de IA para Nuevo Hábito -->
            @if (hasAIFeatures)
            {
                <div class="habits-card prediction-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-crystal-ball me-2"></i>
                            Predicción de Éxito
                            <span class="badge bg-purple ms-1">AI</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="prediction-form">
                            <div class="form-group">
                                <label for="habit-name">Nombre del hábito</label>
                                <input type="text" id="habit-name" class="form-control" placeholder="Ej: Meditación matutina">
                            </div>
                            <div class="form-group">
                                <label for="habit-frequency">Frecuencia semanal</label>
                                <select id="habit-frequency" class="form-control">
                                    <option value="1">1 día/semana</option>
                                    <option value="2">2 días/semana</option>
                                    <option value="3" selected>3 días/semana</option>
                                    <option value="4">4 días/semana</option>
                                    <option value="5">5 días/semana</option>
                                    <option value="6">6 días/semana</option>
                                    <option value="7">7 días/semana</option>
                                </select>
                            </div>
                            <button id="btn-predict" class="btn btn-primary w-100">
                                <i class="fas fa-chart-line me-2"></i>Predecir Éxito
                            </button>
                        </div>
                        <div id="prediction-result" class="prediction-result" style="display: none;">
                            <div class="prediction-header">
                                <h4 id="prediction-title"></h4>
                                <span id="prediction-confidence" class="confidence-badge"></span>
                            </div>
                            <div class="prediction-content">
                                <p id="prediction-message"></p>
                                <div class="prediction-factors">
                                    <h5>Factores Clave:</h5>
                                    <ul id="prediction-factors"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }

            <!-- Estadísticas Rápidas -->
            <div class="habits-card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-chart-bar me-2"></i>
                        Estadísticas Rápidas
                    </h3>
                </div>
                <div class="card-body">
                    <div class="quick-stats">
                        <div class="stat-item">
                            <div class="stat-icon completed">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">@(stats?.TodayCompletions ?? 0)</div>
                                <div class="stat-label">Hoy</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon week">
                                <i class="fas fa-calendar-week"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">@(stats?.WeekCompletions ?? 0)</div>
                                <div class="stat-label">Esta semana</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon month">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">@(stats?.MonthCompletions ?? 0)</div>
                                <div class="stat-label">Este mes</div>
                            </div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-icon streak">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value">@(stats?.LongestStreak ?? 0)</div>
                                <div class="stat-label">Mejor racha</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categorías Populares -->
            @if (stats?.TopCategories != null && stats.TopCategories.Any())
            {
                <div class="habits-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-tags me-2"></i>
                            Categorías Populares
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="categories-list">
                            @foreach (var category in stats.TopCategories)
                            {
                                <div class="category-item">
                                    <span class="category-name">@category.Key</span>
                                    <span class="category-count">@category.Value</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- Upsell de Planes -->
            @if (userPlan != null && userPlan.Price == 0)
            {
                <div class="habits-card upsell-card">
                    <div class="card-body text-center">
                        <i class="fas fa-robot fa-2x mb-3" style="color: #8b5cf6;"></i>
                        <h5 style="color: #1e293b; margin-bottom: 0.5rem;">¿Quieres recomendaciones inteligentes?</h5>
                        <p style="color: #64748b; font-size: 0.9rem; margin-bottom: 1rem;">
                            Actualiza a un plan superior para obtener análisis de IA y recomendaciones personalizadas
                        </p>
                        <a href="@Url.Action("Index", "Plans")" class="btn btn-primary btn-sm">
                            <i class="fas fa-crown me-1"></i>Ver Planes
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Sistema de IA para Hábitos
        document.addEventListener('DOMContentLoaded', function() {
            // Predicción de éxito de hábitos
            const predictBtn = document.getElementById('btn-predict');
            if (predictBtn) {
                predictBtn.addEventListener('click', async function() {
                    const habitName = document.getElementById('habit-name').value;
                    const frequency = document.getElementById('habit-frequency').value;

                    if (!habitName.trim()) {
                        alert('Por favor, ingresa un nombre para el hábito');
                        return;
                    }

                    try {
                        const response = await fetch('@Url.Action("PredictHabitSuccess", "Habits")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                habitName: habitName,
                                frequency: parseInt(frequency)
                            })
                        });

                        if (response.ok) {
                            const prediction = await response.json();
                            displayPredictionResult(prediction);
                        } else {
                            alert('Error al obtener la predicción');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al conectar con el servidor');
                    }
                });
            }

            function displayPredictionResult(prediction) {
                const resultDiv = document.getElementById('prediction-result');
                const title = document.getElementById('prediction-title');
                const confidence = document.getElementById('prediction-confidence');
                const message = document.getElementById('prediction-message');
                const factorsList = document.getElementById('prediction-factors');

                title.textContent = `Probabilidad de éxito: ${prediction.successProbability.toFixed(1)}%`;
                confidence.textContent = prediction.confidenceLevel;
                confidence.style.background = getConfidenceColor(prediction.confidenceLevel);
                message.textContent = prediction.recommendation;

                factorsList.innerHTML = '';
                prediction.keyFactors.forEach(factor => {
                    const li = document.createElement('li');
                    li.textContent = factor;
                    factorsList.appendChild(li);
                });

                resultDiv.style.display = 'block';
            }

            function getConfidenceColor(level) {
                switch (level.toLowerCase()) {
                    case 'high': return '#10b981';
                    case 'medium': return '#f59e0b';
                    case 'low': return '#ef4444';
                    default: return '#6b7280';
                }
            }

            // Toggle de favoritos
            document.querySelectorAll('.btn-favorite').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const habitId = this.dataset.habitId;
                    const isActive = this.classList.contains('active');

                    try {
                        const response = await fetch('@Url.Action("ToggleFavorite", "Habits")', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ id: parseInt(habitId) })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                this.classList.toggle('active');
                                this.title = isActive ? "Agregar a favoritos" : "Quitar de favoritos";
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                });
            });

            // Completar hábito
            document.querySelectorAll('.btn-complete').forEach(btn => {
                btn.addEventListener('click', async function() {
                    const habitId = this.dataset.habitId;
                    const date = this.dataset.date;

                    try {
                        const response = await fetch(`@Url.Action("ToggleCompletion", "Habits")?id=${habitId}&date=${date}`, {
                            method: 'POST'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.success) {
                                location.reload(); // Recargar para actualizar estadísticas
                            } else {
                                alert('Error al completar el hábito');
                            }
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error de conexión');
                    }
                });
            });

            // Cambiar vista (grid/list)
            document.querySelectorAll('.btn-view').forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.dataset.view;
                    document.querySelectorAll('.btn-view').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    const habitsView = document.getElementById('habits-view');
                    habitsView.className = `habits-${view}`;
                });
            });
        });
    </script>
}

@functions {
    private string GetConfidenceColor(double confidence)
    {
        return confidence switch
        {
            >= 0.8 => "#10b981",  // Verde
            >= 0.6 => "#f59e0b",  // Amarillo
            _ => "#ef4444"        // Rojo
        };
    }

    private string GetRecommendationTypeDisplay(string type)
    {
        return type switch
        {
            "TimeOptimization" => "Optimización de Tiempo",
            "Consistency" => "Consistencia",
            "Progression" => "Progresión",
            "NewHabit" => "Nuevo Hábito",
            _ => type
        };
    }
}

<style>
    /* === ESTILOS ESPECÍFICOS PARA HÁBITOS === */
    .habits-container {
        padding: 2rem;
        background: var(--gray-50);
        min-height: 100vh;
    }

    .habits-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-200);
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }

    .habits-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #10b981, #84cc16, #f59e0b);
    }

    .habits-title {
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--gray-800);
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, #10b981, #84cc16);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .habits-subtitle {
        color: var(--gray-500);
        margin: 0;
        font-size: 1.1rem;
    }

    /* Grid de Hábitos */
    .habits-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 1.5rem;
    }

    .habit-card {
        background: white;
        border-radius: var(--border-radius);
        padding: 1.5rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-200);
        transition: var(--transition);
        position: relative;
    }

    .habit-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
        border-color: var(--gray-300);
    }

    .habit-header {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .habit-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        flex-shrink: 0;
    }

    .habit-info {
        flex: 1;
    }

    .habit-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--gray-800);
        margin: 0 0 0.25rem 0;
    }

    .habit-category {
        color: var(--gray-500);
        font-size: 0.9rem;
        margin: 0;
        font-weight: 500;
    }

    .habit-actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-favorite {
        background: none;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: var(--transition);
    }

    .btn-favorite:hover {
        background: var(--gray-100);
        color: var(--warning);
    }

    .btn-favorite.active {
        color: var(--warning);
    }

    .btn-more {
        background: none;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 6px;
        transition: var(--transition);
    }

    .btn-more:hover {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    /* Progreso del Hábito */
    .habit-progress {
        margin-bottom: 1rem;
    }

    .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .progress-label {
        color: var(--gray-600);
        font-weight: 500;
    }

    .progress-stats {
        color: var(--gray-700);
        font-weight: 600;
    }

    .progress-bar {
        height: 6px;
        background: var(--gray-200);
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #84cc16);
        border-radius: 3px;
        transition: width 0.5s ease;
    }

    /* Estadísticas del Hábito */
    .habit-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--border-radius-xs);
    }

    .stat-item {
        text-align: center;
    }

    .stat-item i {
        color: #10b981;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .stat-value {
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--gray-800);
        display: block;
        line-height: 1;
    }

    .stat-label {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Botón de Completar */
    .btn-complete {
        width: 100%;
        padding: 0.75rem;
        background: var(--gray-100);
        color: var(--gray-700);
        border: 2px solid var(--gray-300);
        border-radius: var(--border-radius-xs);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .btn-complete:hover {
        background: var(--gray-200);
        border-color: var(--gray-400);
    }

    .btn-complete.completed {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        border-color: #10b981;
    }

    .btn-complete.completed:hover {
        background: rgba(16, 185, 129, 0.2);
    }

    /* Estadísticas Rápidas */
    .quick-stats {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .quick-stats .stat-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--gray-50);
        border-radius: var(--border-radius-xs);
        border: 1px solid var(--gray-200);
    }

    .quick-stats .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1rem;
        flex-shrink: 0;
    }

    .quick-stats .stat-icon.completed { background: #10b981; }
    .quick-stats .stat-icon.week { background: #3b82f6; }
    .quick-stats .stat-icon.month { background: #8b5cf6; }
    .quick-stats .stat-icon.streak { background: #f59e0b; }

    .quick-stats .stat-content {
        flex: 1;
    }

    .quick-stats .stat-value {
        font-size: 1.25rem;
        font-weight: 800;
        color: var(--gray-800);
    }

    .quick-stats .stat-label {
        font-size: 0.8rem;
        color: var(--gray-500);
        font-weight: 500;
    }

    /* Categorías */
    .categories-list {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .category-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: var(--gray-50);
        border-radius: var(--border-radius-xs);
        border: 1px solid var(--gray-200);
    }

    .category-name {
        font-weight: 600;
        color: var(--gray-700);
    }

    .category-count {
        background: var(--gray-200);
        color: var(--gray-600);
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 700;
    }

    /* Formulario de Predicción */
    .prediction-form {
        margin-bottom: 1.5rem;
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.9rem;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: var(--border-radius-xs);
        font-size: 0.9rem;
        transition: var(--transition);
    }

    .form-control:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .prediction-result {
        background: var(--gray-50);
        border-radius: var(--border-radius-xs);
        padding: 1.5rem;
        border: 1px solid var(--gray-200);
    }

    .prediction-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .prediction-header h4 {
        margin: 0;
        color: var(--gray-800);
        font-size: 1.1rem;
    }

    .prediction-content p {
        color: var(--gray-700);
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .prediction-factors h5 {
        color: var(--gray-700);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .prediction-factors ul {
        margin: 0;
        padding-left: 1rem;
        color: var(--gray-600);
    }

    .prediction-factors li {
        margin-bottom: 0.25rem;
        font-size: 0.85rem;
    }

    /* Estilos específicos para componentes de IA en Hábitos */
    .ai-habits-section {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    /* Responsive */
    @@media (max-width: 768px) {
        .habits-content {
            grid-template-columns: 1fr;
        }
        
        .habits-grid {
            grid-template-columns: 1fr;
        }
        
        .habit-stats {
            grid-template-columns: 1fr;
        }
        
        .quick-stats .stat-item {
            flex-direction: column;
            text-align: center;
            gap: 0.5rem;
        }
    }

    /* Utiliza los mismos estilos de IA que en Finanzas para consistencia */
    .alerts-card,
    .recommendations-card,
    .patterns-card,
    .prediction-card {
        border-left: 4px solid #8b5cf6;
        background: linear-gradient(135deg, #faf5ff, #f3e8ff);
    }

    .alert-item,
    .recommendation-item,
    .pattern-item {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: var(--border-radius-xs);
        padding: 1.25rem;
        margin-bottom: 1rem;
        transition: var(--transition);
    }

    .alert-item:hover,
    .recommendation-item:hover,
    .pattern-item:hover {
        transform: translateX(4px);
        box-shadow: var(--shadow-sm);
    }

    .confidence-badge {
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 700;
    }

    .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
    }

    .type-badge.timeoptimization { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
    .type-badge.consistency { background: rgba(245, 158, 11, 0.1); color: #f59e0b; }
    .type-badge.progression { background: rgba(16, 185, 129, 0.1); color: #10b981; }
    .type-badge.newhabit { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
</style>